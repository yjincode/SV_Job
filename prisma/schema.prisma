generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 원본 데이터 저장용 테이블 (PK 없음)
// ============================================

// player_history.csv 원본 (기술적 PK만 있음, 논리적 식별자 아님)
model PlayerHistory {
  id                  Int       @id @default(autoincrement())
  campaignId          String    @map("campaign_id")
  date                DateTime
  action              String
  campaignSessionId   String    @map("campaign_session_id")
  contentId           String    @map("content_id")
  contentSessionId    String    @map("content_session_id")
  contentTitle        String    @map("content_title")
  deviceId            String    @map("device_id")
  durationSecond      Float     @map("duration_second")
  inventoryId         String    @map("inventory_id")
  isoLocalTime        DateTime  @map("iso_local_time")
  isoTime             DateTime  @map("iso_time")
  playerVersion       String    @map("player_version")
  pricingRule         String    @map("pricing_rule")
  contentDuration     Float     @map("content_duration")
  contentSelection    String    @map("content_selection")
  contentVersion      Int       @map("content_version")
  elapsedSecond       Float     @map("elapsed_second")
  playlistCreatedTime DateTime  @map("playlist_created_time")
  sequenceId          String    @map("sequence_id")
  advertiserId        String?   @map("advertiser_id")
  isoTimeDate         DateTime  @map("iso_time_date")
  partDate            DateTime  @map("part_date")

  @@map("player_history")
}

// content_performance.csv 원본 (기술적 PK만 있음, 논리적 식별자 아님)
model ContentPerformance {
  id           Int      @id @default(autoincrement())
  contentId    String   @map("content_id")
  title        String
  audienceId   String   @map("audience_id")
  age          String
  gender       String
  playAt       DateTime @map("play_at")
  attentionSec Float    @map("attention_sec")
  isAttention  Boolean  @map("is_attention")
  isEntrance   Boolean  @map("is_entrance")
  contentGroup String   @map("content_group")

  @@map("content_performance")
}

// ============================================
// 스타 스키마: Dimension Tables
// ============================================

// Campaign 테이블 (Dimension) - 광고(캠페인) 마스터
model Campaign {
  id           Int      @id @default(autoincrement())
  campaignId   String   @unique @map("campaign_id")
  contentId    String   @map("content_id")
  contentTitle String   @map("content_title")
  createdAt    DateTime @default(now()) @map("created_at")

  events       Event[]

  @@index([campaignId])
  @@map("campaign")
}

// Customer 테이블 (Dimension) - 고객 마스터
model Customer {
  id             Int      @id @default(autoincrement())
  customerId     String   @unique @map("customer_id") // audience_id
  gender         String
  age            String
  totalWatchTime Float    @default(0) @map("total_watch_time") // 총 attention_sec 합산
  createdAt      DateTime @default(now()) @map("created_at")

  events         Event[]

  @@index([customerId])
  @@map("customer")
}

// ============================================
// 스타 스키마: Fact Table
// ============================================

// Event 테이블 (Fact) - Campaign과 Customer를 연결하는 팩트 테이블
model Event {
  id           Int      @id @default(autoincrement())
  campaignId   String   @map("campaign_id")
  customerId   String   @map("customer_id") // audience_id
  playAt       DateTime @map("play_at")
  isAttention  Boolean  @map("is_attention")
  isEntrance   Boolean  @map("is_entrance")
  attentionSec Float    @map("attention_sec")
  createdAt    DateTime @default(now()) @map("created_at")

  campaign     Campaign @relation(fields: [campaignId], references: [campaignId])
  customer     Customer @relation(fields: [customerId], references: [customerId])

  @@index([campaignId])
  @@index([customerId])
  @@index([playAt])
  @@map("event")
}

// ============================================
// KPI 집계 테이블
// ============================================

// Pre-aggregated KPI summary for O(1) queries
model PerformanceSummary {
  id            Int      @id @default(autoincrement())
  campaignId    String   @unique @map("campaign_id")
  contentTitle  String   @map("content_title")
  impressions   Int
  attentionRate Float    @map("attention_rate")
  entranceRate  Float    @map("entrance_rate")
  grade         String
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@index([entranceRate])
  @@map("performance_summary")
}

// Campaign detail statistics (age/gender distribution, watch time, etc.)
model CampaignDetail {
  id                Int      @id @default(autoincrement())
  campaignId        String   @unique @map("campaign_id")
  totalViewers      Int      @map("total_viewers")
  attentionCount    Int      @map("attention_count")
  entranceCount     Int      @map("entrance_count")
  totalWatchTime    Float    @map("total_watch_time")
  ageDistribution   Json     @map("age_distribution")      // [{ age: "18-29", count: 450 }, ...]
  genderDistribution Json    @map("gender_distribution")   // [{ gender: "male", count: 650 }, ...]
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@map("campaign_detail")
}
